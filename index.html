<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhishPlay — Interactive Phishing Awareness Demo</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#94a3b8;--accent:#06b6d4;--success:#10b981;--danger:#ef4444;--glass:rgba(255,255,255,0.04)}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background:linear-gradient(180deg,#071026 0%, #081424 60%); color:#e6eef6; margin:0; padding:24px}
    .wrap{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{margin:0;font-size:20px}
    p.lead{color:var(--muted);margin:6px 0 18px}

    .card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(2,6,23,0.6);margin-bottom:16px}
    .flex{display:flex;gap:12px}
    .spacer{flex:1}

    .progress{height:14px;background:var(--glass);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7c3aed);width:0%}

    .levels{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .level-btn{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:10px;text-align:center;cursor:pointer}
    .level-btn.locked{opacity:.45}

    .game-area{min-height:260px}
    .email{background:#071328;border:1px solid rgba(255,255,255,0.03);padding:14px;border-radius:10px}
    .email .from{font-weight:600;color:#cfeefe}
    .email .subject{font-weight:700;margin-top:6px}
    .choices{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .choice{padding:10px;border-radius:8px;background:rgba(255,255,255,0.02);cursor:pointer;border:1px solid rgba(0,0,0,0.2)}
    .choice:hover{transform:translateY(-2px)}

    footer{margin-top:16px;color:var(--muted);font-size:13px}

    .row{display:flex;gap:12px}
    input[type=text], input[type=name]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit}
    button{background:var(--accent);border:none;padding:10px 12px;border-radius:8px;color:#07202a;font-weight:700;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

    .badge{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(255,255,255,0.03);color:var(--muted);font-weight:600}

    .certificate{padding:20px;background:linear-gradient(180deg,#fff,#f3f4f6);color:#07202a;border-radius:10px}
    .certificate h2{margin:0}
    .hidden{display:none}

    @media (max-width:760px){.levels{grid-template-columns:repeat(2,1fr)}body{padding:12px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">PP</div>
      <div>
        <h1>PhishPlay — Interactive Phishing Awareness</h1>
        <p class="lead">Learn to spot phishing with short levels, instant feedback, and a printable certificate for your technology leader.</p>
      </div>
      <div class="spacer"></div>
      <div class="card" style="min-width:240px;padding:10px;display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <div class="row" style="width:100%"><div class="badge">Level <span id="current-level">1</span></div><div style="flex:1"></div><div class="badge">Points <b id="points">0</b></div></div>
        <div class="progress" aria-hidden="true"><i id="progress-bar"></i></div>
      </div>
    </header>

    <main>
      <section class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <strong>Levels</strong>
          <small class="muted" style="color:var(--muted)">Complete levels to unlock the certificate</small>
        </div>
        <div class="levels" id="levels"></div>
      </section>

      <section class="card game-area" id="game-area">
        <!-- Game content will be injected here -->
        <div id="intro">
          <h3>Welcome!</h3>
          <p style="color:var(--muted)">Start with Level 1: Spot the red flags in a suspicious email. As you answer, you'll earn points and unlock more practice levels. This demo stores progress in your browser (no accounts).</p>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="startBtn">Start Level 1</button>
            <button class="secondary" id="resetBtn">Reset Progress</button>
          </div>
        </div>
      </section>

      <section class="card hidden" id="certificate-area">
        <div class="row" style="align-items:center;justify-content:space-between;margin-bottom:10px">
          <strong>Certificate</strong>
          <div class="row">
            <input id="certName" type="text" placeholder="Your full name" style="min-width:220px" />
            <button id="printCert">Print / Save</button>
          </div>
        </div>
        <div id="certificatePreview" class="certificate">
          <h2 style="text-align:center">Phishing Awareness Certificate</h2>
          <p style="text-align:center;margin-top:8px;">This certifies that</p>
          <h3 id="certPreviewName" style="text-align:center;margin:6px 0">[Name]</h3>
          <p style="text-align:center;margin-top:4px;color:var(--muted)">has successfully completed the PhishPlay training and demonstrated foundational phishing awareness skills.</p>
          <div style="display:flex;justify-content:space-between;margin-top:18px">
            <div>
              <div style="font-weight:700">Points</div>
              <div id="certPoints">0</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:700">Date</div>
              <div id="certDate"></div>
            </div>
          </div>
        </div>
      </section>

    </main>

    <footer>
      <small>Built for education — show this to your technology leader or print the certificate. Want customization? Ask me to brand it and add your org's reporting flow.</small>
    </footer>
  </div>

  <script>
    // Basic data model for levels
    const LEVELS = [
      {id:1,title:'Email Red Flags',desc:'Find what makes this email suspicious',score:100},
      {id:2,title:'Inspect the Link',desc:'Identify safe vs suspicious URLs',score:120},
      {id:3,title:'Attachments & Downloads',desc:'Decide safe handling for attachments',score:120},
      {id:4,title:'Social Engineering',desc:'Spot the manipulation tactics',score:140},
      {id:5,title:'Report & Respond',desc:'Practice reporting and clean up',score:160}
    ];

    // Simple question bank
    const BANK = {
      1: [
        {id:'1a',from:'IT Support <itsupport@yourbank.com>',subject:'URGENT: Verify your account',body:'We detected unusual activity. Click here to verify your credentials: http://yourbank.verify-account.com',choices:[
          {text:'Mark as phishing — contains urgent language + suspicious link',correct:true,explain:'Correct — urgent language + domain mismatch are red flags.'},
          {text:'Safe — it looks like my bank',correct:false,explain:'The domain is not your bank domain and contains extra words.'},
          {text:'Forward to friends',correct:false,explain:'Don\'t forward; this spreads risk.'}
        ]},
        {id:'1b',from:'friend@email.com',subject:'Check out these photos!',body:'Photos attached. Let me know what you think.',choices:[
          {text:'Open attachments — they\'re from a friend',correct:false,explain:'Even if from friend, confirm unexpected attachments before opening.'},
          {text:'Message friend to confirm',correct:true,explain:'Good practice — confirm before opening.'},
          {text:'Ignore',correct:false,explain:'Ignoring may be safe but confirmation is better.'}
        ]}
      ],
      2: [
        {id:'2a',url:'http://apple-secure-id.com/login',question:'Is this URL safe?',choices:[
          {text:'Not safe — domain looks crafted to mimic Apple',correct:true,explain:'Right — lookalike domain.'},
          {text:'Safe — it has apple in the url',correct:false,explain:'Domain name tricks are common.'}
        ]},
        {id:'2b',url:'https://intranet.yourcompany.local/dashboard',question:'Is this likely safe when on the corporate VPN?',choices:[
          {text:'Likely safe (internal host)',correct:true,explain:'Internal hostnames can be safe when on your network.'},
          {text:'Not safe',correct:false,explain:'If not connected to VPN, this would not resolve.'}
        ]}
      ],
      3: [
        {id:'3a',att:'invoice.pdf.exe',question:'This download is named "invoice.pdf.exe". What should you do?',choices:[
          {text:'Delete it immediately — suspicious double extension',correct:false,explain:'Good call but better: do not execute; report or scan it.'},
          {text:'Do not open; report to security',correct:true,explain:'Correct — double extensions are a trick.'}
        ]}
      ],
      4: [
        {id:'4a',scenario:'A manager asks you to buy gift cards ASAP and send photos of the codes.',question:'How do you respond?',choices:[
          {text:'Purchase and send — it seems urgent',correct:false,explain:'This is a classic business email compromise pattern.'},
          {text:'Verify in person or by phone before acting',correct:true,explain:'Always verify with the requester using a known channel.'}
        ]}
      ],
      5: [
        {id:'5a',scenario:'You clicked a link and think you may have given a password.',question:'Next step?',choices:[
          {text:'Change password immediately and notify IT',correct:true,explain:'Correct — mitigate quickly.'},
          {text:'Wait and see',correct:false,explain:'Waiting risks further compromise.'}
        ]}
      ]
    };

    // App state
    let state = {level:1,points:0,completed:[],currentQuestion:null};

    // Load from localStorage
    function loadState(){
      try{
        const s = JSON.parse(localStorage.getItem('phishplay')); if(s) state = s;
      }catch(e){}
      updateUI();
    }
    function saveState(){ localStorage.setItem('phishplay',JSON.stringify(state)); }

    // UI build
    const levelsEl = document.getElementById('levels');
    LEVELS.forEach(l=>{
      const btn = document.createElement('button');
      btn.className='level-btn'; btn.id='lvl-'+l.id; btn.innerHTML=`<strong>Level ${l.id}</strong><div style="font-size:13px;color:var(--muted)">${l.title}</div>`;
      btn.onclick = ()=>startLevel(l.id);
      levelsEl.appendChild(btn);
    });

    function updateUI(){
      document.getElementById('current-level').textContent = state.level;
      document.getElementById('points').textContent = state.points;
      const prog = Math.min(100, Math.round((state.completed.length/LEVELS.length)*100));
      document.getElementById('progress-bar').style.width = prog+'%';

      // lock/unlock
      LEVELS.forEach(l=>{
        const el = document.getElementById('lvl-'+l.id);
        if(state.completed.includes(l.id)) el.style.opacity = .6;
        if(l.id <= state.completed.length+1) el.classList.remove('locked'); else el.classList.add('locked');
      });

      // show certificate area when all complete
      document.getElementById('certificate-area').classList.toggle('hidden', !(state.completed.length >= LEVELS.length));
    }

    // Start functions
    document.getElementById('startBtn').addEventListener('click',()=>startLevel(1));
    document.getElementById('resetBtn').addEventListener('click',()=>{ if(confirm('Reset progress?')){ state={level:1,points:0,completed:[],currentQuestion:null}; saveState(); updateUI(); renderIntro(); }});

    function renderIntro(){
      const area = document.getElementById('game-area'); area.innerHTML = document.getElementById('intro').outerHTML; // restore
      document.getElementById('startBtn').addEventListener('click',()=>startLevel(1));
      document.getElementById('resetBtn').addEventListener('click',()=>{ if(confirm('Reset progress?')){ state={level:1,points:0,completed:[],currentQuestion:null}; saveState(); updateUI(); renderIntro(); }});
    }

    function startLevel(id){
      // only allow next unlocked
      if(id > state.completed.length+1){ alert('Finish earlier levels first.'); return; }
      state.level = id; saveState(); updateUI(); renderLevel(id);
    }

    function renderLevel(id){
      const area = document.getElementById('game-area'); area.innerHTML = '';
      const level = LEVELS.find(l=>l.id===id);
      const title = document.createElement('div'); title.innerHTML = `<h3>Level ${level.id}: ${level.title}</h3><p style="color:var(--muted)">${level.desc}</p>`;
      area.appendChild(title);

      // pick a random question
      const items = BANK[id]; const q = items[Math.floor(Math.random()*items.length)]; state.currentQuestion = q; saveState();

      // render depending on type
      if(id===1){
        const email = document.createElement('div'); email.className='email';
        email.innerHTML = `<div class="from">${q.from}</div><div class="subject">${q.subject}</div><div style="margin-top:8px;color:var(--muted)">${q.body}</div>`;
        area.appendChild(email);
        const choices = document.createElement('div'); choices.className='choices';
        q.choices.forEach(c=>{
          const ch = document.createElement('div'); ch.className='choice'; ch.textContent=c.text; ch.onclick=()=>answerChoice(c); choices.appendChild(ch);
        }); area.appendChild(choices);
      } else if(id===2){
        const el = document.createElement('div'); el.innerHTML=`<p style="color:var(--muted)">${q.question}</p><div class='choices' id='linkChoices'></div>`; area.appendChild(el);
        q.choices.forEach(c=>{const ch=document.createElement('div');ch.className='choice';ch.textContent=c.text;ch.onclick=()=>answerChoice(c);document.getElementById('linkChoices').appendChild(ch)});
      } else if(id===3||id===4||id===5){
        const el = document.createElement('div'); el.innerHTML = `<p style="color:var(--muted)">${q.question||q.scenario}</p><div class='choices' id='otherChoices'></div>`; area.appendChild(el);
        q.choices.forEach(c=>{const ch=document.createElement('div');ch.className='choice';ch.textContent=c.text;ch.onclick=()=>answerChoice(c);document.getElementById('otherChoices').appendChild(ch)});
      }
    }

    function answerChoice(choice){
      // immediate feedback
      const feedback = document.createElement('div'); feedback.style.marginTop='12px'; feedback.style.padding='10px'; feedback.style.borderRadius='8px';
      if(choice.correct){ feedback.style.background='rgba(16,185,129,0.08)'; feedback.innerHTML=`✅ Correct — ${choice.explain}`; state.points += 20; }
      else{ feedback.style.background='rgba(239,68,68,0.06)'; feedback.innerHTML=`❌ Not quite — ${choice.explain}`; state.points += 0; }
      document.querySelector('.game-area').appendChild(feedback);
      saveState(); updateUI();
      // mark level complete after short delay
      setTimeout(()=>{
        if(!state.completed.includes(state.level)) state.completed.push(state.level);
        saveState(); updateUI();
        if(state.completed.length >= LEVELS.length){ showCertificateReady(); } else {
          if(state.level < LEVELS.length){ if(confirm('Level complete! Move to next level?')) startLevel(state.level+1); else renderIntro(); }
        }
      },900);
    }

    function showCertificateReady(){
      document.getElementById('game-area').innerHTML = `<div style="padding:12px"><h3>All levels complete 🎉</h3><p style='color:var(--muted)'>You're ready to generate your certificate. Enter your name and print or save the certificate to share with your tech leader.</p></div>`;
      document.getElementById('certificate-area').classList.remove('hidden');
      document.getElementById('certPoints').textContent = state.points;
      document.getElementById('certDate').textContent = new Date().toLocaleDateString();
    }

    // --- Certificate HTML builder (fix for </script> parsing) ---
    function buildCertificateHTML(name, points, dateStr){
      const safeName = escapeHtml(name);
      return `<!doctype html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Certificate</title><style>body{font-family:Inter,Arial;color:#07202a;padding:40px;background:#fff;margin:0} .cert{border:6px solid #06b6d4;padding:36px;border-radius:12px;max-width:900px;margin:0 auto} h1,h2{margin:0 0 8px 0}</style></head><body><div class='cert'><h1 style='text-align:center'>Phishing Awareness Certificate</h1><p style='text-align:center'>This certifies that</p><h2 style='text-align:center'>${safeName}</h2><p style='text-align:center'>has completed the PhishPlay interactive phishing awareness training.</p><div style='display:flex;justify-content:space-between;margin-top:40px'><div>Points: ${points}</div><div>Date: ${escapeHtml(dateStr)}</div></div></div><script>window.onload=function(){setTimeout(function(){window.print()},300)}<\/script></body></html>`;
    }

    // Certificate print
    document.getElementById('printCert').addEventListener('click',()=>{
      const name = document.getElementById('certName').value.trim() || 'Name';
      document.getElementById('certPreviewName').textContent = name;
      document.getElementById('certPoints').textContent = state.points;
      document.getElementById('certDate').textContent = new Date().toLocaleDateString();

      const html = buildCertificateHTML(name, state.points, new Date().toLocaleDateString());
      const w = window.open('', '_blank');
      if(!w){ alert('Pop-up blocked: allow pop-ups to print your certificate.'); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();
    });

    function escapeHtml(s){ return String(s).replace(/[&<>\"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

    // --- Minimal runtime tests (dev console) ---
    (function(){
      try{
        const t = buildCertificateHTML('Tester', 123, '2025-09-19').trim();
        console.assert(t.includes('<\\/script>'), 'Certificate HTML must escape </script>');
        console.assert(/^<!doctype html>/i.test(t), 'Certificate HTML should start with a doctype');
        console.assert(/<\/html>$/.test(t), 'Certificate HTML should end with </html>');
      }catch(e){ console.warn('Self-test failed:', e); }
    })();

    // Init
    loadState();
    if(state.completed.length>=LEVELS.length) showCertificateReady();
  </script>
</body>
</html>
